<!DOCTYPE html>
<html>
	<style> 
		#audio{ 
			display: none;
		}

		.play-button{ 
			position:absolute;
			z-index: 100;
		}

		html {
		width: 100%;
		height: 100%;
		
		background: #8200c9; /* Old browsers */
		background: -moz-linear-gradient(top,  #E0B0FF 0%,  #11e8bb 100%); /* FF3.6-15 */
		background: -webkit-linear-gradient(top,  #E0B0FF 0%,  #11e8bb 100%); /* Chrome10-25,Safari5.1-6 */
		background: linear-gradient(to bottom, #E0B0FF 0%,  #11e8bb 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
		filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#8200c9', endColorstr='#11e8bb',GradientType=0 ); /* IE6-9 */
		}

	</style> 
	<head>
		<meta charset=utf-8>
	</head>
	<body> 
		<title>CMMND EP X Creative Labs</title>
			<style>
				body { margin: 0; }
				canvas { width: 100%; height: 100% }
			</style>
			<button class="play-button" onclick="playAudio()" >play</button>
			<audio id="audio" controls>
				<source src="./assets/audio/the_way.mp3" type="audio/mpeg">
			</audio> 
	</body>
        <!-- Load libs -->
		<script src="./lib/three.min.js"></script>
		<script src="./lib/OrbitControls.js"></script>
		<script src="./lib/OBJLoader.js"></script>
		<script src="./lib/MTLLoader.js"></script>


		<!-- Scenes -->
		<!-- dynamically change according to timing of music -->
		<script id="currentScene" src="./src/scenes/beach.js"></script> 
		
		<script>
			/* todo: 
				make platform shrubery 
			*/

			/* audio object interfaces songs */ 
			var AudioContext, theway;

			AudioContext = window.AudioContext || window.webkitAudioContext;
			theway = document.getElementById('audio');


			var context = new AudioContext;


			function playAudio() { 

				console.log("play audio")

				context.resume().then( () => { 

					audio.load()
					audio.play();

				});
				
			}

			var analyser = context.createAnalyser();


			var source = context.createMediaElementSource(theway);
			source.connect(analyser); 


			analyser.connect(context.destination);
			analyser.smoothingTimeConstant = .8;
			analyser.fftSize = 1024;


			var bufferlen = analyser.frequencyBinCount;
			var pitch_array = new Uint8Array(bufferlen);
			var volume_array = new Uint8Array(bufferlen);

			/* instantiate loaders */ 
			var objLoader = new THREE.OBJLoader();
			var textureLoader = new THREE.TextureLoader();
			var mtlLoader = new THREE.MTLLoader();

			var scene = new THREE.Scene();

			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

			/* initialize renderer */
			var renderer = new THREE.WebGLRenderer({alpha: true});


			renderer.setSize( window.innerWidth, window.innerHeight );
			
			/* shadow map renderer */ 
			renderer.shadowMap.enabled = true;
			renderer.shadowMap.type = THREE.PCFSoftShadowMap;
			renderer.shadowCameraNear = 3;
			renderer.shadowCameraFar = camera.far;
			renderer.shadowCameraFov = 50;

			renderer.shadowMapBias = 0.0039;
			renderer.shadowMapDarkness = 0.7;
			renderer.shadowMapWidth = 1024;
			renderer.shadowMapHeight = 1024;

			document.body.appendChild( renderer.domElement );



			var controls = new THREE.OrbitControls(camera);
			
			controls.zoomSpeed = .5;
			controls.minAzimuthAngle = - Math.PI/2;
			controls.maxAzimuthAngle = Math.PI/2;

			controls.enablePan = true;
	


			/* add platform and car other universal scene objects*/
			var cliff, plane, car;
		
			var shrubs = [];


			function initPlatform() { 
				
				const map = (val, smin, smax, emin, emax) => (emax-emin)*(val-smin)/(smax-smin) + emin

				//randomly displace the x,y,z coords by the `per` value
				const jitter = (geo,per) => geo.vertices.forEach(v => {

					v.x += map(Math.random(),0,1,-per,per)
					v.y += map(Math.random(),0,1,-per,per)
					v.z += map(Math.random(),0,1,-per,per)

				})

				let geometry = new THREE.TorusGeometry( 10, 3, 8, 50 );
				let planeGeometry = new THREE.PlaneGeometry( 16, 16, 16, 16 );

				
				planeGeometry.rotateX(Math.PI);
				planeGeometry.translate(0,0,-2);

				geometry.merge(planeGeometry);
				jitter(geometry,0.2);

				let material = new THREE.MeshPhongMaterial( { 
					color: 0xEDC9AF,
					flatShading: true
				} );


				cliff = new THREE.Mesh( geometry, material );
				cliff.rotation.x = Math.PI/2;
				cliff.position.y = -10
				cliff.position.z = 60;

				scene.add( cliff );
				

			}


			/* load each file */
			var objFiles = ["carBody","backLeftWheel", "backRightWheel", "frontLeftWheel", "frontRightWheel", "carHood"];

			var idx = 0;

			mtlLoader.setPath( './assets/models/car_model/' );

			objFiles.forEach( (objFile) => { 

				mtlLoader.load( objFile + '.mtl', 
					
					function ( materials ) {

						materials.preload();
							// load a car
						objLoader.setMaterials( materials );	
						objLoader.setPath( './assets/models/car_model/' );
						objLoader.load( objFile + '.obj',

							function ( obj ) {

								idx++;
								obj.rotation.y = Math.PI;
								setCar(obj );
								
							},
						
							function ( xhr ) {

								console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );

							},
							
							function ( error ) {

								console.log( 'An error happened' );

							}
						);

		});

		})
			
			

			// initalize first scene
			function render(){ 

				requestAnimationFrame(render);

			
				animate();


				renderer.render( scene, camera );

			}

			// timer class
			// class Timer () { }


			initPlatform();
			initScene();
			render();
		
		</script>
	</body>
</html>