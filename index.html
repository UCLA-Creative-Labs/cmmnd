<!DOCTYPE html>
<html>
	<style> 
		#audio{ 
			display: none;
		}

		.play-button{ 
			position:absolute;
			opacity: 0;
			z-index: 100;
		}

		.mediaPlayer{ 
			width: 50%;
			height: 60%;
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			margin: auto;
			background-image: url("./assets/media_player.jpg");
			background-repeat: no-repeat;
			background-size:100% 100%;

		}
		
		body { margin: 0; }

		canvas { 
			
			background: #8200c9; /* Old browsers */
			background: -moz-linear-gradient(top,  #E0B0FF 0%,  #11e8bb 100%); /* FF3.6-15 */
			background: -webkit-linear-gradient(top,  #E0B0FF 0%,  #11e8bb 100%); /* Chrome10-25,Safari5.1-6 */
			background: linear-gradient(to bottom, #E0B0FF 0%,  #11e8bb 100%); /* W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */
			
		 }
	</style> 
	<head>
		<meta charset=utf-8>
		<title>CMMND EP X Creative Labs</title>
		<!-- <div class="mediaPlayer"> </div> -->
	</head>
	<body> 
		
	</body>
        <!-- Load libs -->
		<script src="./lib/three.min.js"></script>
		<script src="./lib/tween.min.js"></script>
		<script src="./lib/OrbitControls.js"></script>
		<script src="./lib/OBJLoader.js"></script>
		<script src="./lib/MTLLoader.js"></script>
		
		

		<!-- Scenes -->
	
		<!-- <script id="beachscene" src="./src/scenes/beach.js"></script>  -->
		<script id="intersection" src="./src/scene/intersection.js"></script>
		<script src="./src/objects.js"> </script>
		<!-- <script src="./src/scenes/space.js"></script>  -->
		<!-- <script src="./src/scenes/cmmnd.js"></script> 
		<script src="./src/scenes/intersection.js"></script> 
		<script src="./src/scenes/sunset.js"></script> 
		
		<script src="./src/scenes/twinpeaks.js"></script>  -->
		
		
		
		<script>
			/* TODO: 
				- add scripts dynamically
				- sunset scene
				- scene merging 
				- post processing effect
				- play audio in succession (done)
			*/ 

			const context = window.AudioContext || window.webkitAudioContext;

			var clock = new THREE.Clock();

			/* 
			audioController object 
				controls audio data 
				interfaces user audio interaction
				controls order of scenes in playloop()
			*/ 
			class AudioController { 
			//web audio api stuff
				constructor() { 

					this.context = new context;
					this.analyser = this.context.createAnalyser();
					this.analyser.smoothingTimeConstant = .8;
					this.bufferlen = this.analyser.frequencyBinCount;
					this.pitch_array = new Uint8Array(this.bufferlen);
					this.volume_array = new Uint8Array(this.bufferlen);

					this.songs = { 
						INTRO: new Audio("./assets/cmmnd_live/1.wav"),
						THEWAY: new Audio("./assets/cmmnd_live/2.wav"),
						TENTOES: new Audio("./assets/cmmnd_live/3.wav"),
						BAGFLIP: new Audio("./assets/cmmnd_live/4.wav"),
						SUICIDE: new Audio("./assets/cmmnd_live/5.wav"),
						INDAROCKET: new Audio("./assets/cmmnd_live/6.wav"),
					}

					// scene name to audio mapping
					this.scenes = { 
						// test
						INTRO: "BEACH", 
						THEWAY: "SPACE"
						// INTRO: "CMMND", 
						// THEWAY: "SUNSET",
						// TENTOES: "BEACH",
						// BAGFLIP: "INTERSECTION",
						// SUICIDE: "TWINPEAKS",
						// INDAROCKET: "SPACE",
					}
				
					this.titles = Object.keys(this.songs);
			
					// new array of audio sources
					this.sources = [];
					
					this.titles.forEach((title) => { 
						this.sources.push(this.context.createMediaElementSource(this.songs[title]));
					});

					// the current scene being rendered 
					this.currentScene; 		
					this.currentSong;
					this.index = 0;

				}

		
				// returns the audio for the next song
				getAudio () { 
					const title = this.titles[this.index];
					return this.songs[title];
				};

				
				getFreqData() { 
					this.analyser.getByteFrequencyData(this.pitch_array);
					return this.pitch_array;
				}

				
				getVolumeData() {
					this.analyser.getByteTimeDomainData(this.volume_array);
					return this.volume_array;
				}

				// setup webaudio to play next song
				// add event listener to each song
				// callback increments index
				// last callback restarts the index
				// play first song
				playLoop() { 

					// play first song
					const i = this.index;
					this.currentSong = this.songs[this.titles[i]];
					this.currentSong.addEventListener("ended", function(){

							// play the next song
							console.log("play next")
							this.index++;
							this.playLoop(this.index); 
							if (this.index === 6) 
							{
								console.log('song loop ended') 
								return; 
							} // restart audio
						
						}.bind(this));

					this.getAudio().play();
					this.sources[i].connect(this.analyser);
					this.analyser.connect(this.context.destination);

				}
		
			}

			/* play loop on click */ 
			const audio = new AudioController(); 
			audio.playLoop();
			
			var scene = new THREE.Scene();

			var camera = new THREE.PerspectiveCamera( 75, window.innerWidth/window.innerHeight, 0.1, 1000 );

			/* initialize renderer */
			var renderer = new THREE.WebGLRenderer({alpha: true});

			renderer.setSize( window.innerWidth, window.innerHeight );
			
			/* shadow map renderer */ 
			renderer.shadowMap.enabled = true;
			renderer.shadowMap.type = THREE.PCFSoftShadowMap;
			renderer.shadowCameraNear = 3;
			renderer.shadowCameraFar = camera.far;
			renderer.shadowCameraFov = 50;

			renderer.shadowMapBias = 0.0039;
			renderer.shadowMapDarkness = 0.7;
			renderer.shadowMapWidth = 1024;
			renderer.shadowMapHeight = 1024;

			document.body.appendChild( renderer.domElement );



			var controls = new THREE.OrbitControls(camera);
			
			controls.zoomSpeed = .5;
			controls.minAzimuthAngle = - Math.PI/2;
			controls.maxAzimuthAngle = Math.PI/2;

			controls.enablePan = true;

			// initalize first scene
			function render(){ 

				// switch to decide which scene to render
				requestAnimationFrame(render);

			
				animate();


				renderer.render( scene, camera );

			}


			// initPlatform();
			// BeachScene();
			render();
		
		</script>
	</body>
</html>