<!DOCTYPE html>
<html>
	<style> 
		#audio{ 
			display: none;
		}

		.play-button{ 
			position:absolute;
			opacity: 0;
			z-index: 100;
		}

		.mediaPlayer{ 
			width: 50%;
			height: 60%;
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			margin: auto;
			background-image: url("./assets/media_player.jpg");
			background-repeat: no-repeat;
			background-size:100% 100%;

		}
		
		body { margin: 0; }

		canvas { 
			
			background: #000000; /* Old browsers */
			/* background: -moz-linear-gradient(top,  #E0B0FF 0%,  #11e8bb 100%); /* FF3.6-15 */
			/* background: -webkit-linear-gradient(top,  #E0B0FF 0%,  #11e8bb 100%); Chrome10-25,Safari5.1-6 */
			/* background: linear-gradient(to bottom, #E0B0FF 0%,  #11e8bb 100%); W3C, IE10+, FF16+, Chrome26+, Opera12+, Safari7+ */ 
			
		 }


	</style> 
	<head>
		<meta charset=utf-8>
		<title>CMMND EP X Creative Labs</title>
		<!-- <div class="mediaPlayer"> </div> -->
	</head>
	<body> 
		<button id="prev">prev</button>
		<button id="next">next</button>
		<button id="play">play</button>
	</body>
        <!-- Load libs -->
		<script src="./lib/three.min.js"></script>
		<script src="./lib/tween.min.js"></script>
		<script src="./lib/OrbitControls.js"></script>
		<script src="./lib/OBJLoader.js"></script>
		<script src="./lib/MTLLoader.js"></script>
		<script src="./lib/EffectComposer.js"></script>
		<script src="./lib/RenderPass.js"></script>
		<script src="./lib/ShaderPass.js"></script>
		<script src="./lib/CopyShader.js"></script>
		<script src="./lib/BadTVShader.js"></script>
		<script src="./lib/threex.proceduralcity.js"></script>

		<!-- Scenes -->
	
		<script src="./src/scenes/cmmnd.js"></script> 
		<script src="./src/scenes/beach.js"></script> 
		<script src="./src/scenes/space.js"></script> 
	
		<script src="./src/scenes/intersection.js"></script> 
		<script src="./src/scenes/sunset.js"></script> 
		<script src="./src/scenes/twinpeaks.js"></script>  
		
		<script src="./src/objects.js"> </script>
		
		
		<script>
			/* TODO: 
				- add scripts dynamically
				- sunset scene
				- scene merging*** (works)
					- fix positioning bug
				- post processing effect
				- play audio in succession (done)
				- loading manager (wait for car to load before beginning scene)
					- on load to play audio
			*/ 

			const context = window.AudioContext || window.webkitAudioContext;

			/* 
			audioController object 
				controls audio data 
				interfaces user audio interaction
				controls order of scenes in playloop()
			*/ 
			class AudioController { 
				constructor() { 
					/* web audio stuff */
					this.context = new context;
					this.analyser = this.context.createAnalyser();
					this.analyser.smoothingTimeConstant = .8;
					this.bufferlen = this.analyser.frequencyBinCount;
					this.pitch_array = new Uint8Array(this.bufferlen);
					this.volume_array = new Uint8Array(this.bufferlen);

					/* animation stuff */
					this.animationID;

					/* audio and scene render */
					this.songs = { 
						INTRO: new Audio("./assets/cmmnd_live/4.wav"),
						THEWAY: new Audio("./assets/cmmnd_live/2.wav"),
						TENTOES: new Audio("./assets/cmmnd_live/3.wav"),
						BAGFLIP: new Audio("./assets/cmmnd_live/4.wav"),
						SUICIDE: new Audio("./assets/cmmnd_live/5.wav"),
						INDAROCKET: new Audio("./assets/cmmnd_live/6.wav"),
					}

					/* scene name to audio mapping */
					this.scenes = { 
						// test
						INTRO: "CMMND", 
						THEWAY: "BEACH",
						TENTOES: "SPACE",
						BAGFLIP: "TWINPEAKS",
						SUICIDE: "INTERSECTION",
						// THEWAY: "SUNSET",
						// TENTOES: "BEACH",
						// BAGFLIP: "INTERSECTION",
						// SUICIDE: "TWINPEAKS",
						// INDAROCKET: "SPACE",
					}

					this.sceneObjects = { 
						"CMMND": new IntersectionScene,
						"BEACH": new BeachScene,
						"SPACE": new SpaceScene,
						"TWINPEAKS": new TwinPeaksScene,
					}

					// if scene is initiated
					this.isInitialized = [0,0,0,0,0]; 

					this.titles = Object.keys(this.songs);
			
					// new array of audio sources
					this.sources = [];
					
					this.titles.forEach((title) => { 
						this.sources.push(this.context.createMediaElementSource(this.songs[title]));
					});

					// the current scene object being rendered 
					this.currentScene; 	
					this.scene;	
					this.currentSong;
					this.index = 0;

				}
		
				// returns the audio for the next song
				getAudio () { 
					const title = this.titles[this.index];
					return this.songs[title];
				};

				// gets scene to render based off the current scene
				getScene () { 
					return this.sceneObjects[this.currentScene];
				}
				
				// web audio freq data
				getFreqData() { 
					this.analyser.getByteFrequencyData(this.pitch_array);
					return this.pitch_array;
				}

				// web audio vol data
				getVolumeData() {
					this.analyser.getByteTimeDomainData(this.volume_array);
					return this.volume_array;
				}

				// play next song
				playNext(){ 

					// pause the current song
					this.getAudio().pause();
					this.getAudio().currentTime = 0;
					this.currentSong.removeEventListener("ended", this.songEnded);
					// increment song
					this.index++;
					this.playLoop();

				}

				// play prev song
				playPrev(){ 

					this.getAudio().pause();
					this.getAudio().currentTime = 0;
					this.currentSong.removeEventListener("ended", this.songEnded);
					this.index--; 
					this.playLoop();
				
				}

				// setup webaudio to play next song
				// add event listener to each song
				// callback increments index
				// last callback restarts the index
				// play first song

				playLoop() { 

					function songEnded(){

						console.log("ended");
						// // play the next song
						console.log("play next");
						this.index++;
						this.playLoop(); 
						if (this.index === 6) 
						{
							this.index = 0;
							this.playLoop();
							console.log('song loop restarted');
						} // restart audio

					}
					// play first song
					const i = this.index;
					this.currentSong = this.songs[this.titles[i]];
					this.currentScene = this.scenes[this.titles[i]];
					this.scene = this.sceneObjects[this.currentScene];
					console.log(this.scene, "current scene obj");

					console.log(this.isInitialized[i]);
					if (!this.isInitialized[i]) {
						console.log("init scene")
						this.scene.initScene();
						this.isInitialized[i] = 1;
					}
					else { 
						this.scene.setObjects();
					}
						
					controls = new THREE.OrbitControls(this.scene.camera);
					controls.zoomSpeed = .5;
					// controls.minAzimuthAngle = - Math.PI/2;
					// controls.maxAzimuthAngle = Math.PI/2;
					controls.enablePan = true;

					this.currentSong.addEventListener("ended", songEnded.bind(this) );

					this.getAudio().play();
					this.sources[i].connect(this.analyser);
					this.analyser.connect(this.context.destination);

				}
		
			}

			/* three.js initialization */
			const clock = new THREE.Clock();
			const manager = new THREE.LoadingManager();

			manager.onStart = function ( url, itemsLoaded, itemsTotal ) {

				console.log( 'Started loading file: ' + url + '.\nLoaded ' + itemsLoaded + ' of ' + itemsTotal + ' files.' );

			};

			manager.onLoad = function () {

				// initialize audio when objects load
						/* audio controller controls audio + scene integration */ 	
				console.log( 'Loading complete!');
				// display play button
				console.log( car );


			}

			manager.onError = function ( url ) {

				console.log( 'There was an error loading ' + url );

			};

			const objLoader = new THREE.OBJLoader(manager);
			const textureLoader = new THREE.TextureLoader(manager);
			const mtlLoader = new THREE.MTLLoader(manager);
			var controls;

			var renderer = new THREE.WebGLRenderer({alpha: true});
			renderer.setSize( window.innerWidth, window.innerHeight );

			/* common objects */
			var audio = new AudioController();
				var car = new THREE.Group();
				var archLogo;
				var cliff, grass;

			/* buttons */ 
			document.getElementById('next').addEventListener('click', function(){
				audio.playNext();
			});
			document.getElementById('prev').addEventListener('click', function(){
				audio.playPrev();
			});

			document.getElementById('play').addEventListener("click",  function(){
				audio.context.resume();
				audio.playLoop();
				
				//instantiate beach scene
				//initialize scene objects 
				render(audio.scene);
				
			});
	
			/* initialize common objects */ 
				getCar();
				getArchLogo(); // arch logo
				getGrass();

			/* initialize renderer */

			/* post processing effects use these on your scene */
			// effect composer
			// each scene has a separate render pass
			// song ends, 2 seconds to load next scene, shows a bad signal graphic
			// renderpass is used on ending of one scene and beginning of next
			// instantiated in initscene? or constructor 
			// settimeout to call function that disables the renderpass after some time
			// each scene has own composer and renderpass that uses the badTVPass
			
			document.body.appendChild( renderer.domElement );




			// initPlatform();
			// BeachScene();
			// initScene();
			// render();
			// updated scene
			// use audio.getScene to get the scene class to render 
			// pass the scene object we need in to render through a callback function that calls render
			// sceneScene.scene, sceneScene.animate (call these two functions)
			// save render id somewhere to cancel it 
			function render(scene){ 

				audio.animationID = requestAnimationFrame(() => (render(audio.scene)));
				scene.animate();
				renderer.render( scene.scene, scene.camera );

			}
		
		</script>
	</body>
</html>